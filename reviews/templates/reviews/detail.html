{% block content %} {% load django_bootstrap5 %}
<h2>detail</h2>
<!-- 작성 디테일 -->
<div>
    <p>{{ review.pk }}번 게시글 | 작성자:<a href="{% url 'accounts:detail' review.user.pk %}">{{ review.user.username }}</a></p>
    <p>글 작성:{{ review.created_at|date:"SHORT_DATETIME_FORMAT" }} | 최종수정:{{ review.updated_at|date:"y-m-d D" }}</p>
</div>
<!-- 내용 -->
<div>
    <table class="table">
        <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">리뷰 제목</th>
              <th scope="col">영화 제목</th>
              <th scope="col">내용</th>
              <th scope="col">평점</th>
              <th scope="col">작성 시간</th>
            </tr>
          </thead>
        <tbody>
            <th scope="row">내용</th>
            <td>{{review.title}}</td>
            <td>{{review.movie_name}}</td>
            <td>{{review.content}}</td>
            <td>{{review.grade}} 점</td>
            <td>{{review.created_at}}</td>
        </tbody>
    </table>
</div>
<!-- like -->
<div class="my-3">
    {% if request.user.is_authenticated %}
    {% if request.user in review.like_users.all %}
        <i id="like-btn" data-article-id="{{ review.pk }}" class="bi bi-heart-fill"></i>
    {% else %}
        <i id="like-btn" data-article-id="{{ review.pk }}" class="bi bi-heart"></i>
    {% endif %}
    {% endif %}
    <span id="like-count">{{ review.like_users.count }}</span>
</div>
<!-- 수정삭제 -->
<div class="m-5">
    {% if request.user == review.user %}
    <a href="{% url 'reviews:update' review.pk %}"><button type="button" class="btn">수정</button></a>
    <a href="{% url 'reviews:delete' review.pk %}"><button type="button" class="btn">삭제</button></a>
    {% endif %}
</div>
<!-- 댓글 -->
<div class="m-5">
    {% if request.user.is_authenticated %}
    <form id="comment-form" data-article-id="{{ review.pk }}">
        {% csrf_token %}
        {% bootstrap_form comment_form layout='floating'%}
        {% bootstrap_button button_type="submit" content="OK" %}
    </form>
    {% endif %}
    <hr>
    <div id="comments">
        {% for comment in comments %}
        <div class="d-flex justify-content-between">
          <p>{{ forloop.counter }}. 작성:{{ comment.user.username }} | {{ comment.content }}</p>
          <p>{{ review.created_at|date:"SHORT_DATETIME_FORMAT" }}</p>
        </div>
        {% if request.user.pk == review.user.pk %}
        <p class="text-end"><a class="btn btn-outline-danger" href="{% url 'reviews:comment_delete' review.pk comment.pk %}">댓글삭제</a></p>
        {% endif %}
        <hr>    
        {% empty %}
        <p>댓글이 없어요 ㅠ_ㅠ</p>
        {% endfor %}
    </div>
</div>
<!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 좋아요 비동기 -->
    <script>
      const likeBtn = document.querySelector('#like-btn')
      likeBtn.addEventListener('click', function (event) {
        console.log(event.target.dataset)
        axios({
          method: 'get',
          url: `/articles/${event.target.dataset.articleId}/like`
        })
        .then(response => {
          console.log(response)
          console.log(response.data)
          if (response.data.isLiked === true) {
            event.target.classList.add('bi-heart-fill')
            event.target.classList.remove('bi-heart')
          } else {
            event.target.classList.add('bi-heart')
            event.target.classList.remove('bi-heart-fill')
          }
          const likeCount = document.querySelector('#like-count')
          likeCount.innerText = response.data.likeCount
        })
      })
    </script>

    <!-- 댓글 비동기 -->
    <script>
      const commentForm = document.querySelector('#comment-form')
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
      commentForm.addEventListener('submit', function(event) {
        event.preventDefault();
        axios({
          method: 'post',
          url: `/articles/${event.target.dataset.articleId}/comments/create`,
          headers: {'X-CSRFToken': csrftoken},
          data: new FormData(commentForm)
        })
        .then(response => {
          console.log(response.data)
          const comments = document.querySelector('#comments')
          const p = document.createElement('p')
          p.innerText = `${response.data.userName} | ${response.data.content}`
          const hr = document.createElement('hr')
          comments.append(p, hr) 
          commentForm.reset()
        })
      })
    </script> 
{% endblock content %}